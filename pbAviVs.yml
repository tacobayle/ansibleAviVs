---
- hosts: localhost
  connection: local
  gather_facts: no


  vars_files:
    - "vars/creds.json"
    - "vars/params.yml"

  roles:
    - role: "avinetworks.avisdk"

  tasks:


    - name: get Ipam DNS Profile
      avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        api_version: "{{ avi_credentials.api_version }}"
        http_method: get
        timeout: 300
        path: ipamdnsproviderprofile
      register: ipamDnsOutput
      tags:
        - ipamdns

    - name: Retrieve domainName
      set_fact:
        domainName: "{{ item.internal_profile.dns_service_domain.0.domain_name }}"
      loop: "{{ ipamDnsOutput.obj.results }}"
      when: item.type == "IPAMDNS_TYPE_INTERNAL_DNS"
      tags:
        - ipamdns

    # - name: Debug
    #   debug:
    #     msg: "{{ domainName }}"



    - name: Retrieve IPAM Network details
      set_fact:
        networkUuid: "{{ item.internal_profile.usable_network_refs.0.split('/network/')[1] }}"
      loop: "{{ ipamDnsOutput.obj.results }}"
      when: item.type == "IPAMDNS_TYPE_INTERNAL"

    # - name: Debug
    #   debug:
    #     msg: "{{ networkUuid }}"

    - name: get Network details
      avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        api_version: "{{ avi_credentials.api_version }}"
        http_method: get
        timeout: 300
        path: network
        params:
          page_size: -1
      register: networkOutput
      tags:
        - ipamdns

    - name: Retrieve Network details
      set_fact:
        networkName: "{{ item.name }}"
        networkMask: "{{ item.configured_subnets.0.prefix.mask }}"
        networkAddress: "{{ item.configured_subnets.0.prefix.ip_addr.addr }}"
        networkType: "{{ item.configured_subnets.0.prefix.ip_addr.type }}"
      loop: "{{ networkOutput.obj.results }}"
      when: item.uuid == networkUuid
      tags:
        - ipamdns

    # - name: Debug
    #   debug:
    #     msg: "{{ networkName }}"
    #
    # - name: Debug
    #   debug:
    #     msg: "{{ networkMask }}"
    #
    # - name: Debug
    #   debug:
    #     msg: "{{ networkAddress }}"
    #
    # - name: Debug
    #   debug:
    #     msg: "{{ networkType }}"

    - name: Create HTTP health monitor
      avi_healthmonitor:
        avi_credentials: "{{ avi_credentials }}"
        api_version: "{{ avi_credentials.api_version }}"
        avi_api_update_method: patch
        avi_api_patch_op: add
        name: "{{ item.name }}"
        http_monitor:
          http_request: "{{ item.http_request }}"
          http_response_code: "{{ item.http_response_code }}"
        receive_timeout: "{{ item.receive_timeout }}"
        failed_checks: "{{ item.failed_checks }}"
        send_interval: "{{ item.send_interval }}"
        successful_checks: "{{ item.successful_checks }}"
        type: "{{ item.type }}"
      loop: "{{ avi_healthmonitor }}"
      when: item.type == "HEALTH_MONITOR_HTTP"
      tags:
        - hm

    - name: Create pool
      avi_pool:
        avi_credentials: "{{ avi_credentials }}"
        api_version: "{{ avi_credentials.api_version }}"
        name: "{{ item.name }}"
        lb_algorithm: "{{ item.lb_algorithm }}"
        health_monitor_refs:
          - "/api/healthmonitor?name={{ item.health_monitor_refs }}"
        servers: "{{ item.servers }}"
      loop: "{{ avi_pool }}"
      tags:
        - pool

    - name: Create HTTP Virtualservice (based on Dynamic IP - Ipam and DNS)
      avi_virtualservice:
        avi_credentials: "{{ avi_credentials }}"
        api_version: "{{ avi_credentials.api_version }}"
        avi_api_update_method: patch
        avi_api_patch_op: add
        name: "{{ item.name }}"
        ssl_profile_ref: "/api/sslprofile/?name={{ item.ssl_profile_ref | default('System-Standard') }}"
        ssl_key_and_certificate_refs: "/api/sslkeyandcertificate/?name={{ item.ssl_key_and_certificate_refs | default('System-Default-Cert') }}"
        services: "{{ item.services }}"
        pool_ref: "/api/pool?name={{ item.pool_ref }}"
        enable_rhi: "{{ item.enable_rhi | default('false') }}"
        vip:
          - auto_allocate_ip: true
            ipam_network_subnet:
              network_ref: "/api/network/?name={{ item.network_ref | default(network.name) }}"
              subnet:
                mask: "{{ item.mask | default(network.subnet.0.prefix.mask) }}"
                ip_addr:
                  type: "{{ item.type | default(network.subnet.0.prefix.ip_addr.type) }}"
                  addr: "{{ item.addr | default(network.subnet.0.prefix.ip_addr.addr) }}"
        dns_info:
          - fqdn: "{{ item.dns_info.0 | default(item.name + '.' + domainName) }}"
      loop: "{{ virtualservice.http }}"
      register: OutputVsHttp
      tags:
        - vs
